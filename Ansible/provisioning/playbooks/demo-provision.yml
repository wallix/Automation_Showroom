---
# playbooks/demo-provision.yml - Quick demo provisioning
#
# Creates a complete demo environment with:
# - Global domains and accounts
# - Devices with SSH/RDP services
# - Users and user groups
# - Target groups and authorizations
#
# Usage:
#   make demo                 # Interactive mode with confirmation
#   make demo-quick           # No confirmation
#
# Or directly:
#   ansible-playbook playbooks/demo-provision.yml -i inventories/dev/hosts.ini \
#     -e wallix_bastion_host=10.10.122.15 \
#     --vault-password-file <(printf "vault_password")

- name: WALLIX Bastion - Demo Provisioning
  hosts: localhost
  gather_facts: false
  connection: local

  vars_files:
    - ../vars/data/demo/infrastructure.yml
    - ../vars/data/demo/users.yml

  pre_tasks:
    - name: Set connection defaults
      set_fact:
        wallix_api_protocol: "{{ wallix_api.protocol | default('https') }}"
        wallix_api_port: "{{ wallix_api.port | default(443) }}"

    - name: Build API base URL
      set_fact:
        wallix_api: "{{ wallix_api | combine({'base_url': wallix_api_protocol ~ '://' ~ wallix_bastion_host ~ ':' ~ wallix_api_port ~ '/api'}) }}"

    - name: Display demo information
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘           WALLIX BASTION - DEMO PROVISIONING             â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘  Target: {{ wallix_api.base_url | default('NOT SET') | truncate(40) }}"
          - "â•‘                                                          â•‘"
          - "â•‘  This will create:                                       â•‘"
          - "â•‘    â€¢ {{ wallix_global_domains | length | default(0) }} Global domains                               â•‘"
          - "â•‘    â€¢ {{ wallix_devices | length | default(0) }} Devices with services                        â•‘"
          - "â•‘    â€¢ {{ wallix_user_groups | length | default(0) }} User groups                                  â•‘"
          - "â•‘    â€¢ {{ wallix_users | length | default(0) }} Users                                          â•‘"
          - "â•‘    â€¢ {{ wallix_target_groups | length | default(0) }} Target groups                               â•‘"
          - "â•‘    â€¢ {{ wallix_authorizations | length | default(0) }} Authorizations                              â•‘"
          - "â•‘                                                          â•‘"
          - "â•‘  All resources will be prefixed with 'demo-' or 'Demo_'  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Confirm demo provisioning
      pause:
        prompt: "Proceed with demo provisioning? [yes/no]"
      register: confirm_demo
      when: not (skip_confirmation | default(false) | bool)

    - name: Check confirmation
      fail:
        msg: "Demo provisioning cancelled by user"
      when:
        - not (skip_confirmation | default(false) | bool)
        - confirm_demo.user_input != "yes"

  tasks:
    # =========================================================================
    # AUTHENTICATION
    # =========================================================================
    - name: "ðŸ” Authenticate to Bastion"
      include_role:
        name: wallix-auth
      tags: [auth]

    - name: Verify session
      debug:
        msg: "âœ… Authenticated - Session cookie acquired"
      when: wallix_session_cookie is defined

    # =========================================================================
    # INFRASTRUCTURE: Domains & Global Accounts
    # =========================================================================
    - name: "ðŸ“ Create Global Domains"
      include_role:
        name: wallix-global-domains
      when: wallix_global_domains is defined
      tags: [domains]

    - name: "ðŸ”‘ Create Global Accounts"
      include_role:
        name: wallix-global-accounts
      when: wallix_global_accounts is defined
      tags: [accounts]

    # =========================================================================
    # TARGETS: Devices & Services
    # =========================================================================
    - name: "ðŸ–¥ï¸ Create Devices and Services"
      include_role:
        name: wallix-devices
      when: wallix_devices is defined
      tags: [devices]

    # =========================================================================
    # ACCESS: Users & Groups
    # =========================================================================
    - name: "ðŸ‘¥ Create User Groups"
      include_role:
        name: wallix-users
        tasks_from: create_user_groups.yml
      when: wallix_user_groups is defined
      tags: [users]

    - name: "ðŸ‘¤ Create Users"
      include_role:
        name: wallix-users
      when: wallix_users is defined
      tags: [users]

    # =========================================================================
    # AUTHORIZATIONS: Target Groups & Mappings
    # =========================================================================
    - name: "ðŸŽ¯ Create Target Groups"
      include_role:
        name: wallix-authorizations
        tasks_from: create_target_groups.yml
      when: wallix_target_groups is defined
      tags: [authorizations]

    - name: "ðŸ” Create Authorizations"
      include_role:
        name: wallix-authorizations
      when: wallix_authorizations is defined
      tags: [authorizations]

    # =========================================================================
    # OPTIONAL: Timeframes
    # =========================================================================
    - name: "â° Create Timeframes"
      include_role:
        name: wallix-timeframes
      when: wallix_timeframes is defined
      tags: [timeframes]

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Demo Summary
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘              ðŸŽ‰ DEMO PROVISIONING COMPLETE ðŸŽ‰            â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘  Bastion: {{ wallix_bastion_host | default('unknown') }}"
          - "â•‘                                                          â•‘"
          - "â•‘  Created resources:                                      â•‘"
          - "â•‘    â€¢ Global Domains:  {{ wallix_global_domains_created | default(0) }}"
          - "â•‘    â€¢ Global Accounts: {{ wallix_global_accounts_created | default(0) }}"
          - "â•‘    â€¢ Devices:         {{ wallix_devices_created | default(0) }}"
          - "â•‘    â€¢ Services:        {{ wallix_services_configured | default(0) }}"
          - "â•‘    â€¢ User Groups:     {{ wallix_user_groups_created | default(0) }}"
          - "â•‘    â€¢ Users:           {{ wallix_users_created | default(0) }}"
          - "â•‘    â€¢ Target Groups:   {{ wallix_target_groups_created | default(0) }}"
          - "â•‘    â€¢ Authorizations:  {{ wallix_authorizations_created | default(0) }}"
          - "â•‘                                                          â•‘"
          - "â•‘  Demo users created:                                     â•‘"
          - "â•‘    â€¢ demo_admin (product_administrator profile)          â•‘"
          - "â•‘    â€¢ demo_operator1, demo_operator2                      â•‘"
          - "â•‘    â€¢ demo_dev1, demo_dev2                                â•‘"
          - "â•‘    â€¢ demo_dba                                            â•‘"
          - "â•‘    â€¢ demo_auditor (auditor profile)                      â•‘"
          - "â•‘                                                          â•‘"
          - "â•‘  To clean up: make cleanup-demo                          â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
