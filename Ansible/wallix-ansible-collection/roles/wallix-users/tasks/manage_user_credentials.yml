---
# User credentials management tasks for WALLIX users
# Supports password, SSH keys, and X.509 certificates

- name: Display credentials management start
  ansible.builtin.debug:
    msg:
      - "ðŸ” Starting user credentials management"
      - "Users to process: {{ wallix_users | selectattr('credentials', 'defined') | list | length }}"

- name: Get existing users for credential management
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users"
    method: GET
    headers:
      Cookie: "{{ wallix_session_cookie }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200]
    return_content: true
  register: existing_users_for_credentials
  when: wallix_users_mode != 'dry_run'

# Step 1: Configure user authentication methods first (required by WALLIX API)
- name: Configure SSH authentication method for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      user_auths: ["local_sshkey"]
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.ssh_public_key is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: ssh_auth_results
  no_log: false

# Step 2: Set SSH public keys for users (after authentication method is configured)
- name: Set SSH public keys for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      ssh_public_key: "{{ item.credentials.ssh_public_key }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.ssh_public_key is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: ssh_key_results
  no_log: false

# Step 3: Configure X.509 authentication method for users
- name: Configure X.509 authentication method for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      user_auths: ["local_x509"]
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.certificate_dn is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: x509_auth_results
  no_log: false

# Step 4: Set X.509 certificates for users (after authentication method is configured)
- name: Set X.509 certificates for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      certificate_dn: "{{ item.credentials.certificate_dn }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.certificate_dn is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: certificate_results
  no_log: false

- name: Upload X.509 certificate files for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}/certificate"
    method: POST
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/x-pem-file"
    body: "{{ lookup('file', item.credentials.certificate_file) }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 201, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.certificate_file is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: certificate_file_results
  no_log: false

- name: Set GPG public keys for users
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      gpg_public_key: "{{ item.credentials.gpg_public_key }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.gpg_public_key is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: gpg_key_results
  no_log: false

- name: Update user authentication methods
  ansible.builtin.uri:
    url: "{{ wallix_api.base_url }}/users/{{ item.name }}"
    method: PUT
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      user_auths: "{{ item.credentials.authentication_methods | default(['local_password']) }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 204, 409]
    return_content: true
  loop: "{{ wallix_users }}"
  vars:
    user_exists: "{{ existing_users_for_credentials.json | selectattr('user_name', 'equalto', item.name) | list | length > 0 }}"
  when:
    - item.state | default('present') == 'present'
    - item.credentials is defined
    - item.credentials.authentication_methods is defined
    - wallix_users_mode != 'dry_run'
    - user_exists
  register: auth_methods_results
  no_log: false

- name: Debug SSH key setup results
  ansible.builtin.debug:
    msg:
      - "User: {{ item.item.name }}"
      - "SSH Key: Set"
      - "Status: {{ item.status }}"
      - "Result: {{ 'Success' if item.status in [200, 204] else 'Already exists' if item.status == 409 else 'Error' }}"
  loop: "{{ ssh_key_results.results | default([]) }}"
  when:
    - ssh_key_results.results is defined
    - not item.skipped | default(false)
    - wallix_users_debug.enabled | default(false)

- name: Debug certificate setup results
  ansible.builtin.debug:
    msg:
      - "User: {{ item.item.name }}"
      - "Certificate DN: {{ item.item.credentials.certificate_dn }}"
      - "Status: {{ item.status }}"
      - "Result: {{ 'Success' if item.status in [200, 204] else 'Already exists' if item.status == 409 else 'Error' }}"
  loop: "{{ certificate_results.results | default([]) }}"
  when:
    - certificate_results.results is defined
    - not item.skipped | default(false)
    - wallix_users_debug.enabled | default(false)

- name: Debug certificate file upload results
  ansible.builtin.debug:
    msg:
      - "User: {{ item.item.name }}"
      - "Certificate File: Uploaded"
      - "Status: {{ item.status }}"
      - "Result: {{ 'Success' if item.status in [200, 201, 204] else 'Already exists' if item.status == 409 else 'Error' }}"
  loop: "{{ certificate_file_results.results | default([]) }}"
  when:
    - certificate_file_results.results is defined
    - not item.skipped | default(false)
    - wallix_users_debug.enabled | default(false)

- name: Set credentials management status
  ansible.builtin.set_fact:
    wallix_user_credentials_ssh_set: >-
      {{ ssh_key_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 204]) | list | length }}
    wallix_user_credentials_certificates_set: >-
      {{ certificate_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 204]) | list | length }}
    wallix_user_credentials_certificate_files_uploaded: >-
      {{ certificate_file_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 201, 204]) | list | length }}
    wallix_user_credentials_gpg_set: >-
      {{ gpg_key_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 204]) | list | length }}
    wallix_user_credentials_auth_methods_updated: >-
      {{ auth_methods_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 204]) | list | length }}
    wallix_user_credentials_status: "success"

- name: Display credentials management summary
  ansible.builtin.debug:
    msg:
      - "âœ… User credentials management completed"
      - "SSH keys set: {{ wallix_user_credentials_ssh_set | default(0) }}"
      - "X.509 certificates set: {{ wallix_user_credentials_certificates_set | default(0) }}"
      - "Certificate files uploaded: {{ wallix_user_credentials_certificate_files_uploaded | default(0) }}"
      - "GPG keys set: {{ wallix_user_credentials_gpg_set | default(0) }}"
      - "Authentication methods updated: {{ wallix_user_credentials_auth_methods_updated | default(0) }}"
