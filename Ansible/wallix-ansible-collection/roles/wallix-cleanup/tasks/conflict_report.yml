---
# Generate conflict report for resources that couldn't be deleted due to constraints

- name: "âš ï¸ Collect all constraint violations"
  set_fact:
    wallix_cleanup_conflicts:
      target_groups: "{{ delete_target_group_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_target_group_result is defined else [] }}"
      user_groups: "{{ delete_user_group_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_user_group_result is defined else [] }}"
      devices: "{{ delete_device_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_device_result is defined else [] }}"
      users: "{{ delete_user_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_user_result is defined else [] }}"
      global_accounts: "{{ delete_global_account_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_global_account_result is defined else [] }}"
      global_domains: "{{ delete_global_domain_result.results | default([]) | selectattr('status', 'equalto', 409) | list if delete_global_domain_result is defined else [] }}"
      timeframes: "{{ timeframe_delete_result.results | default([]) | selectattr('status', 'equalto', 409) | list if timeframe_delete_result is defined else [] }}"
      connection_policies: "{{ connection_policy_delete_result.results | default([]) | selectattr('status', 'equalto', 409) | list if connection_policy_delete_result is defined else [] }}"

- name: "ðŸ“Š Calculate total conflicts"
  set_fact:
    wallix_cleanup_total_conflicts: >-
      {{
        (wallix_cleanup_conflicts.target_groups | length) +
        (wallix_cleanup_conflicts.user_groups | length) +
        (wallix_cleanup_conflicts.devices | length) +
        (wallix_cleanup_conflicts.users | length) +
        (wallix_cleanup_conflicts.global_accounts | length) +
        (wallix_cleanup_conflicts.global_domains | length) +
        (wallix_cleanup_conflicts.timeframes | length) +
        (wallix_cleanup_conflicts.connection_policies | length)
      }}

- name: "âš ï¸ Display conflict report header"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âš ï¸  CLEANUP CONFLICT REPORT"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "Total resources with constraint violations: {{ wallix_cleanup_total_conflicts }}"
      - ""
  when: wallix_cleanup_total_conflicts | int > 0

- name: "âš ï¸ Target Groups - Conflict details"
  debug:
    msg:
      - "ðŸŽ¯ Target Group: {{ item.item.group_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still referenced in authorizations"
  loop: "{{ wallix_cleanup_conflicts.target_groups }}"
  loop_control:
    label: "{{ item.item.group_name }}"
  when:
    - wallix_cleanup_conflicts.target_groups | length > 0

- name: "âš ï¸ User Groups - Conflict details"
  debug:
    msg:
      - "ðŸ‘¥ User Group: {{ item.item.group_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still has members or references"
  loop: "{{ wallix_cleanup_conflicts.user_groups }}"
  loop_control:
    label: "{{ item.item.group_name }}"
  when:
    - wallix_cleanup_conflicts.user_groups | length > 0

- name: "âš ï¸ Devices - Conflict details"
  debug:
    msg:
      - "ðŸ’» Device: {{ item.item.device_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still has accounts or active sessions"
  loop: "{{ wallix_cleanup_conflicts.devices }}"
  loop_control:
    label: "{{ item.item.device_name }}"
  when:
    - wallix_cleanup_conflicts.devices | length > 0

- name: "âš ï¸ Users - Conflict details"
  debug:
    msg:
      - "ðŸ‘¤ User: {{ item.item.user_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still has active sessions or group memberships"
  loop: "{{ wallix_cleanup_conflicts.users }}"
  loop_control:
    label: "{{ item.item.user_name }}"
  when:
    - wallix_cleanup_conflicts.users | length > 0

- name: "âš ï¸ Global Accounts - Conflict details"
  debug:
    msg:
      - "ðŸ”‘ Global Account: {{ item.item.account_name }} (Domain: {{ item.item.domain_name }})"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still referenced in authorizations"
  loop: "{{ wallix_cleanup_conflicts.global_accounts }}"
  loop_control:
    label: "{{ item.item.account_name }}"
  when:
    - wallix_cleanup_conflicts.global_accounts | length > 0

- name: "âš ï¸ Global Domains - Conflict details"
  debug:
    msg:
      - "ðŸŒ Global Domain: {{ item.item.domain_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still contains accounts"
  loop: "{{ wallix_cleanup_conflicts.global_domains }}"
  loop_control:
    label: "{{ item.item.domain_name }}"
  when:
    - wallix_cleanup_conflicts.global_domains | length > 0

- name: "âš ï¸ Timeframes - Conflict details"
  debug:
    msg:
      - "â° Timeframe: {{ item.item.timeframe_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still referenced in authorizations"
  loop: "{{ wallix_cleanup_conflicts.timeframes }}"
  loop_control:
    label: "{{ item.item.timeframe_name }}"
  when:
    - wallix_cleanup_conflicts.timeframes | length > 0

- name: "âš ï¸ Connection Policies - Conflict details"
  debug:
    msg:
      - "ðŸ”— Connection Policy: {{ item.item.connection_policy_name }}"
      - "   Reason: {{ item.json.description | default('Constraint violation') }}"
      - "   Status: Cannot delete - still referenced in authorizations"
  loop: "{{ wallix_cleanup_conflicts.connection_policies }}"
  loop_control:
    label: "{{ item.item.connection_policy_name }}"
  when:
    - wallix_cleanup_conflicts.connection_policies | length > 0

- name: "âš ï¸ Conflict report summary"
  debug:
    msg:
      - ""
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ðŸ“Š CONFLICT SUMMARY BY TYPE"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "Target Groups: {{ wallix_cleanup_conflicts.target_groups | length }} conflicts"
      - "User Groups: {{ wallix_cleanup_conflicts.user_groups | length }} conflicts"
      - "Devices: {{ wallix_cleanup_conflicts.devices | length }} conflicts"
      - "Users: {{ wallix_cleanup_conflicts.users | length }} conflicts"
      - "Global Accounts: {{ wallix_cleanup_conflicts.global_accounts | length }} conflicts"
      - "Global Domains: {{ wallix_cleanup_conflicts.global_domains | length }} conflicts"
      - "Timeframes: {{ wallix_cleanup_conflicts.timeframes | length }} conflicts"
      - "Connection Policies: {{ wallix_cleanup_conflicts.connection_policies | length }} conflicts"
      - ""
      - "ðŸ’¡ TIP: To resolve conflicts, delete authorizations first,"
      - "   then retry cleanup for dependent resources."
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  when: wallix_cleanup_total_conflicts | int > 0

- name: "âœ… No conflicts detected"
  debug:
    msg:
      - "âœ… No constraint violations detected"
      - "All resources were successfully deleted or skipped"
  when: wallix_cleanup_total_conflicts | int == 0

- name: "ðŸ’¾ Save conflict report to file"
  copy:
    content: |
      {
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "total_conflicts": {{ wallix_cleanup_total_conflicts }},
        "conflicts_by_type": {
          "target_groups": {{ wallix_cleanup_conflicts.target_groups | length }},
          "user_groups": {{ wallix_cleanup_conflicts.user_groups | length }},
          "devices": {{ wallix_cleanup_conflicts.devices | length }},
          "users": {{ wallix_cleanup_conflicts.users | length }},
          "global_accounts": {{ wallix_cleanup_conflicts.global_accounts | length }},
          "global_domains": {{ wallix_cleanup_conflicts.global_domains | length }},
          "timeframes": {{ wallix_cleanup_conflicts.timeframes | length }},
          "connection_policies": {{ wallix_cleanup_conflicts.connection_policies | length }}
        },
        "details": {
          "target_groups": {{ wallix_cleanup_conflicts.target_groups | map(attribute='item') | list | to_nice_json }},
          "user_groups": {{ wallix_cleanup_conflicts.user_groups | map(attribute='item') | list | to_nice_json }},
          "devices": {{ wallix_cleanup_conflicts.devices | map(attribute='item') | list | to_nice_json }},
          "users": {{ wallix_cleanup_conflicts.users | map(attribute='item') | list | to_nice_json }},
          "global_accounts": {{ wallix_cleanup_conflicts.global_accounts | map(attribute='item') | list | to_nice_json }},
          "global_domains": {{ wallix_cleanup_conflicts.global_domains | map(attribute='item') | list | to_nice_json }},
          "timeframes": {{ wallix_cleanup_conflicts.timeframes | map(attribute='item') | list | to_nice_json }},
          "connection_policies": {{ wallix_cleanup_conflicts.connection_policies | map(attribute='item') | list | to_nice_json }}
        }
      }
    dest: "/tmp/wallix_cleanup_conflicts_{{ ansible_date_time.epoch }}.json"
  when:
    - wallix_cleanup_total_conflicts | int > 0
    - wallix_cleanup_reporting.enabled | default(true)
  register: conflict_report_file

- name: "ðŸ“„ Conflict report location"
  debug:
    msg: "Conflict report saved to: {{ conflict_report_file.dest }}"
  when:
    - conflict_report_file is defined
    - conflict_report_file.dest is defined
