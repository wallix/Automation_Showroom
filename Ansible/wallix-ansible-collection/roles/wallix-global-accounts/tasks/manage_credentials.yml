---
# Global domain account credentials management tasks

- name: Get existing global domain account credentials
  uri:
    url: "{{ wallix_api.base_url }}/domains/{{ domain_name }}/accounts/{{ account_identifier }}/credentials"
    method: GET
    headers:
      Cookie: "{{ wallix_session_cookie }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200]
    return_content: yes
  loop: "{{ wallix_global_accounts.accounts | default([]) }}"
  vars:
    # Get account ID from global_account_creation_results if available
    matching_accounts: "{{ global_account_creation_results.results | default([]) | selectattr('item.account_name', 'equalto', item.account_name) | selectattr('item.domain_name', 'equalto', item.domain_name) | list }}"
    account_identifier: "{{ matching_accounts[0].item.account_name if matching_accounts | length > 0 else item.account_name }}"
    domain_name: "{{ item.domain_name }}"
  when:
    - item.state | default('present') == 'present'
    - wallix_global_accounts_mode != 'dry_run'
  register: existing_credentials
  no_log: false
  failed_when: false  # Don't fail if credentials don't exist yet

- name: Set initial credentials for global domain accounts (if provided)
  uri:
    url: "{{ wallix_api.base_url }}/domains/{{ domain_name }}/accounts/{{ account_identifier }}/credentials"
    method: POST
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "password"
      password: "{{ item.password }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 201, 204, 409]
    return_content: yes
  loop: "{{ wallix_global_accounts.accounts | default([]) }}"
  vars:
    matching_accounts: "{{ global_account_creation_results.results | default([]) | selectattr('item.account_name', 'equalto', item.account_name) | selectattr('item.domain_name', 'equalto', item.domain_name) | list }}"
    account_identifier: "{{ matching_accounts[0].item.account_name if matching_accounts | length > 0 else item.account_name }}"
    domain_name: "{{ item.domain_name }}"
  when:
    - item.state | default('present') == 'present'
    - item.password is defined
    - wallix_global_accounts_mode != 'dry_run'
  register: credentials_creation_results
  no_log: true  # Don't log passwords

- name: Set SSH keys for global domain accounts (if provided)
  uri:
    url: "{{ wallix_api.base_url }}/domains/{{ domain_name }}/accounts/{{ account_identifier }}/credentials"
    method: POST
    headers:
      Cookie: "{{ wallix_session_cookie }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "ssh_key"
      private_key: "{{ item.ssh_private_key }}"
      public_key: "{{ item.ssh_public_key | default('') }}"
    validate_certs: "{{ wallix_auth.connection.verify_ssl }}"
    timeout: "{{ wallix_auth.connection.timeout }}"
    status_code: [200, 201, 204, 409]
    return_content: yes
  loop: "{{ wallix_global_accounts.accounts | default([]) }}"
  vars:
    matching_accounts: "{{ global_account_creation_results.results | default([]) | selectattr('item.account_name', 'equalto', item.account_name) | selectattr('item.domain_name', 'equalto', item.domain_name) | list }}"
    account_identifier: "{{ matching_accounts[0].item.account_name if matching_accounts | length > 0 else item.account_name }}"
    domain_name: "{{ item.domain_name }}"
  when:
    - item.state | default('present') == 'present'
    - item.ssh_private_key is defined
    - wallix_global_accounts_mode != 'dry_run'
  register: ssh_credentials_creation_results
  no_log: true  # Don't log SSH keys

- name: Debug credentials setup results (without sensitive data)
  debug:
    msg:
      - "Account: {{ item.item.account_name }}@{{ item.item.domain_name }}"
      - "Credential type: password"
      - "Status: {{ item.status }}"
      - "Result: {{ 'Set' if item.status in [200, 201, 204] else 'Already exists' if item.status == 409 else 'Error' }}"
  loop: "{{ credentials_creation_results.results | default([]) }}"
  when:
    - credentials_creation_results.results is defined
    - not item.skipped | default(false)

- name: Debug SSH credentials setup results (without sensitive data)
  debug:
    msg:
      - "Account: {{ item.item.account_name }}@{{ item.item.domain_name }}"
      - "Credential type: SSH key"
      - "Status: {{ item.status }}"
      - "Result: {{ 'Set' if item.status in [200, 201, 204] else 'Already exists' if item.status == 409 else 'Error' }}"
  loop: "{{ ssh_credentials_creation_results.results | default([]) }}"
  when:
    - ssh_credentials_creation_results.results is defined
    - not item.skipped | default(false)

- name: Set credentials management status
  set_fact:
    wallix_global_credentials_set: >-
      {{
        (credentials_creation_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 201, 204]) | list | length) +
        (ssh_credentials_creation_results.results | default([]) | selectattr('status', 'defined') | selectattr('status', 'in', [200, 201, 204]) | list | length)
      }}
    wallix_global_credentials_status: "success"
