---
# playbooks/test-auth.yml - Test authentication and API connectivity
# Run: ansible-playbook playbooks/test-auth.yml -i inventories/test/hosts.ini -v

- name: Test WALLIX Bastion Authentication
  hosts: bastions
  gather_facts: no

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - wallix_bastion_host is defined
          - vault_wallix_username is defined
          - vault_wallix_password is defined
        fail_msg: "Missing required variables: wallix_bastion_host, vault_wallix_username, vault_wallix_password"

  tasks:
    - name: Include wallix.bastion.auth role
      include_role:
        name: wallix.bastion.auth
      vars:
        wallix_bastion_api_version: "api"

    - name: Display authentication result
      debug:
        msg:
          - "âœ… Authentication successful!"
          - "Bastion: {{ wallix_bastion_host }}"
          - "Session: {{ 'Present' if wallix_session_cookie is defined else 'Not available' }}"
